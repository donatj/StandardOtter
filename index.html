<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<title>Standard Otter</title>
</head>
<body>
<table width="100%" cellpadding="0" cellspacing="0">
	<tr>
		<td width="50%" height="100%"><textarea id="input"></textarea></td>
		<td>&nbsp;</td>
		<td width="50%">
			<table width="100%">
				<tr>
					<td><textarea id="output" readonly></textarea></td>
				</tr>
				<tr id="error-container">
					<td><textarea id="error" readonly></textarea></td>
				</tr>
			</table>
		</td>
	</tr>
	<tr>
		<td height="0" colspan="3" style="padding-bottom: 3px"><input id="cmd" list="cmdlist" />
			<datalist id="cmdlist"></datalist>
		</td>
	</tr>
</table>
<script type="text/javascript">
	"use strict";
	(function() {
		var gui = require('nw.gui'),
			win = gui.Window.get();

		var input          = document.getElementById('input'),
			output         = document.getElementById('output'),
			cmd            = document.getElementById('cmd'),
			error          = document.getElementById('error'),
			errorContainer = document.getElementById('error-container');

		/**
		 * @param {Element} datalist
		 * @param {string[]} options
		 */
		var setDatalistOptions = function( datalist, options ) {
			datalist.innerHTML = '';

			options.forEach(function( e ) {
				var option = document.createElement('option');
				option.textContent = e;

				datalist.appendChild(option);
			});
		};

		var addCmdDatalistOption = function( workingSet, key, time ) {
			workingSet[key] = time || Date.now();
		};

		var cmdList = {};

//		setDatalistOptions(document.getElementById('cmdlist'), [
//			"ruby",
//			"node",
//			"php"
//		]);


		window.initEditor = function() {
			var app = {
				'title': 'Standard Otter'
			};

			var insertAtCursor = function( myField, myValue ) {
				if( myField.selectionStart || myField.selectionStart == '0' ) {
					var startPos = myField.selectionStart;
					var endPos = myField.selectionEnd;
					myField.value = myField.value.substring(0, startPos) + myValue + myField.value.substring(endPos, myField.value.length);
					myField.selectionEnd = myField.selectionStart = startPos + myValue.length;
				} else {
					console.log('wtf');
					myField.value += myValue;
				}
			};

			errorContainer.style.display = 'none';

			input.addEventListener('keydown', function( e ) {
				if( e.keyCode == 9 ) {
					e.preventDefault();
					insertAtCursor(input, "\t");
				}
			});

			var timeout;
			input.addEventListener('keyup', function() {
				var that = this;
				var cmdData = cmd.value.split(' ').filter(function( x ) { return x != '' });

				clearTimeout(timeout);

				function draw() {
					var spawnSync = require('child_process').spawnSync;
					var result = spawnSync(cmdData.shift(), cmdData, {input: that.value});

					output.value = result.stdout;
					error.value = result.stderr;

					console.log(result);

					if( error.value == '' ) {
						errorContainer.style.display = 'none';
					} else {
						errorContainer.style.display = '';
					}

					if( result.status == 0 ) {
						output.style.background = '';
						error.style.background = '';
						document.title = app.title;
					} else {
						output.style.background = '#fee';
						error.style.background = '#fee';
						document.title = app.title + ' - Exit Code: ' + result.status;

						if( result.status !== null ) {
							cmd.style.background = '';
						} else {
							cmd.style.background = '#fee';
						}
					}
				}

				timeout = setTimeout(draw, 300);
			});
		};

		window.getEditorStatus = function() {
			return {
				'cmd'   : cmd.value,
				'input' : input.value,
				'width' : win.width,
				'height': win.height,
				'x'     : win.x,
				'y'     : win.y
			};
		};

		window.restoreEditorStatus = function( status ) {
			cmd.value = status.cmd || '';
			input.value = status.input || '';

			if( status.width && status.height ) {
				win.resizeTo(status.width, status.height);
			}

			if( status.x && status.y ) {
				win.moveTo(status.x, status.y);
			}
		}

	})();
</script>
<link href="style.css" rel="stylesheet" type="text/css">
</body>
</html>