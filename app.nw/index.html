<!DOCTYPE html>
<html>
<script>
	setTimeout((function() {
		"use strict";

		var gui = require('nw.gui'),
			win = gui.Window.get();

		var nativeMenuBar = new gui.Menu({type: "menubar"});

		try {
			nativeMenuBar.createMacBuiltin("Standard Otter");
			win.menu = nativeMenuBar;
		} catch(ex) {
			console.log(ex.message);
		}

		win.hide();

		var childWindows = [];
		var initEditorWindow      = function( status ) {
			var new_win = gui.Window.open('editor.html', {
				"toolbar": false,
				"width"  : 800,
				"height" : 600
			});

			new_win.on('loaded', function() {
				this.window.initEditor();
				this.window.restoreEditorStatus(status);
				this.window.addEventListener('keydown', function( e ) {
					if( e.metaKey && e.which == 78 ) {
						e.preventDefault();
						newEditorWindow();
					}
				});
			});

			childWindows.push(new_win);

			return new_win;
		}, newEditorWindow        = function() {
			initEditorWindow({'cmd': 'cat'});
		}, getSavedEditorStatuses = function() {
			if( !window.localStorage.editorStatuses ) {
				return [];
			}

			return JSON.parse(window.localStorage.editorStatuses);
		};

		var statuses = getSavedEditorStatuses();
		if( statuses.length > 0 ) {
			for( var i = 0; i <= statuses.length - 1; i++ ) {
				initEditorWindow(statuses[i]);
			}
		} else {
			newEditorWindow();
		}

		win.on('close', function() {
			var statuses = [];
			for( var i = 0; i <= childWindows.length - 1; i++ ) {
				try {
					statuses.push(childWindows[i].window.getEditorStatus());
				} catch(e) {
					// window was closed
				}
			}

			window.localStorage.editorStatuses = JSON.stringify(statuses);

			this.close(true);
		});

//		win.showDevTools();

	}), 100);
</script>
</html>